<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="ã“ã®ã‚µã‚¤ãƒˆã¯GOLDé¯–ã®å…¬å¼ã‚µã‚¤ãƒˆã§ã™ã€‚">
<title>GOLDé¯–å…¬å¼ã‚µã‚¤ãƒˆ</title>

<style>
  :root{
    --bg:#0f1115;
    --panel:#161a22;
    --muted:#9aa4b2;
    --text:#e8eaf0;
    --gold:#c8a951;         /* è½ã¡ç€ã„ãŸã‚´ãƒ¼ãƒ«ãƒ‰ */
    --gold-weak:#a89245;
    --accent:#2a2f3a;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI","Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,Arial,sans-serif}
  .app{display:flex;min-height:100dvh}

  /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
  .sidebar{
    width:240px;flex:0 0 240px;background:var(--panel);border-right:1px solid #202634;
    transition:width .2s ease;position:relative
  }
  .sidebar.collapsed{width:64px;flex-basis:64px}
  .brand{display:flex;align-items:center;gap:.6rem;padding:16px 14px;border-bottom:1px solid #202634}
  .brand .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(145deg,var(--gold),var(--gold-weak));box-shadow:0 0 18px rgba(200,169,81,.35)}
  .brand span{font-weight:700;letter-spacing:.3px}
  .toggle{position:absolute;right:-12px;top:14px;width:28px;height:28px;border-radius:50%;border:1px solid #22293a;background:var(--panel);color:var(--text);cursor:pointer}
  .menu{padding:10px}
  .tab-btn{
    width:100%;display:flex;align-items:center;gap:10px;background:transparent;border:none;color:var(--text);
    padding:12px 14px;border-radius:12px;cursor:pointer;font-weight:600;letter-spacing:.2px
  }
  .tab-btn:hover{background:#1c2230}
  .tab-btn.active{background:linear-gradient(145deg,#1c2230,#1b2230);outline:1px solid #273049}
  .icon{width:18px;text-align:center;opacity:.85}
  .collapsed .label{display:none}

  /* ãƒ¡ã‚¤ãƒ³ */
  .main{flex:1;display:flex;flex-direction:column;min-width:0}
  header{
    display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid #202634;background:linear-gradient(180deg,rgba(255,255,255,.02),transparent)
  }
  header .title{font-weight:800;letter-spacing:.3px}
  header .user{font-size:.95rem;color:var(--muted)}
  .content{padding:20px;display:grid;gap:16px}

  /* ãƒ‘ãƒãƒ« */
  .card{
    background:var(--panel);border:1px solid #202634;border-radius:16px;padding:18px
  }
  .card h2{margin:0 0 12px 0;font-size:1.1rem}
  .muted{color:var(--muted)}

  /* èªè¨¼ãƒ•ã‚©ãƒ¼ãƒ  */
  .auth-grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:760px){.auth-grid{grid-template-columns:1fr 1fr}}
  .field{display:grid;gap:6px;margin-bottom:10px}
  .input,.select,.btn{
    background:#12161f;border:1px solid #22293a;color:var(--text);
    padding:12px 14px;border-radius:12px;font-size:0.95rem
  }
  .input:focus,.select:focus{outline:2px solid #31405b}
  .btn{cursor:pointer;font-weight:700;letter-spacing:.2px}
  .btn.gold{background:linear-gradient(145deg,var(--gold),var(--gold-weak));color:#1b1b1b;border:none}
  .btn.ghost{background:transparent;border:1px solid #2a344a}
  .row{display:flex;gap:10px;flex-wrap:wrap}

  /* ãƒªã‚¹ãƒˆ */
  ul.list{list-style:none;margin:0;padding:0;display:grid;gap:8px}
  .item{
    background:#12161f;border:1px solid #22293a;border-radius:12px;padding:12px;
    display:flex;justify-content:space-between;align-items:center;gap:12px
  }
  .item .time{font-size:.85rem;color:var(--muted)}
  .item .danger{background:#2a1113;border-color:#4a2023;color:#efb0b5}

  /* éè¡¨ç¤ºãƒ˜ãƒ«ãƒ‘ */
  .hidden{display:none !important}
</style>
</head>
<body>
<div class="app">
  <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
  <aside id="sidebar" class="sidebar hidden"><!-- æœªãƒ­ã‚°ã‚¤ãƒ³æ™‚ã¯éè¡¨ç¤º -->
    <div class="brand">
      <div class="logo"></div>
      <span class="label">GOLDé¯–</span>
      <button id="toggle" class="toggle" title="æŠ˜ã‚ŠãŸãŸã¿">â‰¡</button>
    </div>
    <nav id="menu" class="menu">
      <button class="tab-btn active" data-tab="account"><span class="icon">ğŸ‘¤</span><span class="label">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</span></button>
      <button class="tab-btn" data-tab="news"><span class="icon">ğŸ“°</span><span class="label">ãƒ‹ãƒ¥ãƒ¼ã‚¹</span></button>
      <button class="tab-btn" data-tab="tl"><span class="icon">ğŸ’¬</span><span class="label">TL</span></button>
    </nav>
  </aside>

  <!-- ãƒ¡ã‚¤ãƒ³ -->
  <main class="main">
    <header>
      <div class="title">GOLDé¯– å…¬å¼ã‚µã‚¤ãƒˆ</div>
      <div class="user"><span id="userEmail" class="muted">æœªãƒ­ã‚°ã‚¤ãƒ³</span></div>
    </header>

    <section class="content">
      <!-- èªè¨¼ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ï¼æ–°è¦ç™»éŒ²ï¼‰ -->
      <div id="authCard" class="card">
        <h2>ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</h2>
        <p class="muted">ãƒ¡ãƒ¼ãƒ«ï¼†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§èªè¨¼ã—ã¾ã™ã€‚</p>
        <div class="auth-grid">
          <form id="loginForm" class="card" onsubmit="return false;">
            <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
            <label class="field">ãƒ¡ãƒ¼ãƒ«<input id="loginEmail" class="input" type="email" required></label>
            <label class="field">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰<input id="loginPass" class="input" type="password" required></label>
            <button class="btn gold" id="loginBtn">ãƒ­ã‚°ã‚¤ãƒ³</button>
          </form>
          <form id="regForm" class="card" onsubmit="return false;">
            <h2>æ–°è¦ç™»éŒ²</h2>
            <label class="field">ãƒ¡ãƒ¼ãƒ«<input id="regEmail" class="input" type="email" required></label>
            <label class="field">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰<input id="regPass" class="input" type="password" required></label>
            <button class="btn ghost" id="regBtn">ç™»éŒ²</button>
          </form>
        </div>
      </div>

      <!-- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ -->
      <div id="tab-account" class="card hidden">
        <h2>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š</h2>
        <div class="row">
          <label class="field" style="min-width:240px;flex:1">
            ãƒ¦ãƒ¼ã‚¶ãƒ¼å
            <input id="username" class="input" placeholder="GOLDé¯–ãƒãƒ¼ãƒ "/>
          </label>
          <label class="field" style="min-width:240px;width:240px">
            é€šçŸ¥
            <select id="notify" class="select">
              <option value="all">ã™ã¹ã¦</option>
              <option value="important">é‡è¦ã®ã¿</option>
              <option value="none">ãªã—</option>
            </select>
          </label>
        </div>
        <div class="row">
          <button id="saveProfile" class="btn gold">ä¿å­˜</button>
          <button id="logout" class="btn ghost">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
        <p id="roleBadge" class="muted" style="margin-top:10px"></p>
      </div>

      <!-- ãƒ‹ãƒ¥ãƒ¼ã‚¹ -->
      <div id="tab-news" class="card hidden">
        <h2>å…¬å¼ãƒ‹ãƒ¥ãƒ¼ã‚¹</h2>
        <ul id="newsList" class="list"></ul>
        <div id="newsAdmin" class="row hidden" style="margin-top:10px">
          <button id="postNews" class="btn gold">ãƒ‹ãƒ¥ãƒ¼ã‚¹æŠ•ç¨¿ï¼ˆç®¡ç†è€…ï¼‰</button>
        </div>
      </div>

      <!-- TL -->
      <div id="tab-tl" class="card hidden">
        <h2>ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h2>
        <ul id="tlList" class="list"></ul>
        <!-- TLæŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  -->
<div class="field">
  <textarea id="tlInput" class="input" placeholder="æŠ•ç¨¿å†…å®¹ã‚’å…¥åŠ›"></textarea>
</div>
<button id="tlPostBtn" class="btn gold">æŠ•ç¨¿ã™ã‚‹</button>

      </div>
    </section>
  </main>
</div>

<!-- Firebaseï¼ˆESMï¼‰ -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signInWithEmailAndPassword,
    createUserWithEmailAndPassword, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, collection, addDoc, deleteDoc,
    getDocs, serverTimestamp, query, orderBy
  } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

  /* Firebaseè¨­å®š */
  const firebaseConfig = {
    apiKey: "AIzaSyBqXi5wgR6yTgg_O70wk_I7tZsEIBT3kyI",
    authDomain: "gold-50f64.firebaseapp.com",
    projectId: "gold-50f64",
    storageBucket: "gold-50f64.firebasestorage.app",
    messagingSenderId: "880208667520",
    appId: "1:880208667520:web:64ad9329d1a4ab61385765"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
  let currentProfile = null;

  // DOMå–å¾—
  const sidebar     = document.getElementById('sidebar');
  const toggle      = document.getElementById('toggle');
  const menu        = document.getElementById('menu');
  const userEmailEl = document.getElementById('userEmail');

  const authCard    = document.getElementById('authCard');
  const loginForm   = document.getElementById('loginForm');
  const regForm     = document.getElementById('regForm');
  const loginBtn    = document.getElementById('loginBtn');
  const regBtn      = document.getElementById('regBtn');

  const tabAccount  = document.getElementById('tab-account');
  const tabNews     = document.getElementById('tab-news');
  const tabTl       = document.getElementById('tab-tl');

  const usernameInp = document.getElementById('username');
  const notifySel   = document.getElementById('notify');
  const saveProfile = document.getElementById('saveProfile');
  const logoutBtn   = document.getElementById('logout');
  const roleBadge   = document.getElementById('roleBadge');

  const newsList    = document.getElementById('newsList');
  const newsAdmin   = document.getElementById('newsAdmin');
  const postNewsBtn = document.getElementById('postNews');

  const tlList      = document.getElementById('tlList');
  const tlInput     = document.getElementById('tlInput');
  const tlPostBtn   = document.getElementById('tlPostBtn');

  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  function show(el){ el.classList.remove('hidden'); }
  function hide(el){ el.classList.add('hidden'); }
  function setActiveTab(name){
    $$('.tab-btn', menu).forEach(b=>b.classList.toggle('active', b.dataset.tab===name));
    hide(tabAccount); hide(tabNews); hide(tabTl);
    const map = { account:tabAccount, news:tabNews, tl:tabTl };
    show(map[name]);
  }
  function fmt(ts){
    try{
      const d = ts?.toDate ? ts.toDate() : new Date(ts);
      return new Intl.DateTimeFormat('ja-JP', { dateStyle:'short', timeStyle:'short' }).format(d);
    }catch{return '';}
  }

  // ã‚µã‚¤ãƒ‰ãƒãƒ¼æŠ˜ã‚ŠãŸãŸã¿
  toggle?.addEventListener('click', ()=> sidebar.classList.toggle('collapsed'));

  // ã‚¿ãƒ–åˆ‡æ›¿
  menu.addEventListener('click', (e)=>{
    const btn = e.target.closest('.tab-btn');
    if(!btn) return;
    setActiveTab(btn.dataset.tab);
  });

  // ãƒ­ã‚°ã‚¤ãƒ³
  loginBtn.addEventListener('click', async ()=>{
    const email = document.getElementById('loginEmail').value.trim();
    const pass  = document.getElementById('loginPass').value;
    try{
      await signInWithEmailAndPassword(auth, email, pass);
    }catch(err){ alert(`ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ${err.message}`); }
  });

  // æ–°è¦ç™»éŒ²
  regBtn.addEventListener('click', async ()=>{
    const email = document.getElementById('regEmail').value.trim();
    const pass  = document.getElementById('regPass').value;
    try{
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      await setDoc(doc(db, 'users', cred.user.uid), {
        Role:'User', username:'', notify:'all', createdAt: serverTimestamp()
      });
      alert('ç™»éŒ²æˆåŠŸï¼ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚');
    }catch(err){ alert(`ç™»éŒ²å¤±æ•—: ${err.message}`); }
  });

  // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜
  saveProfile.addEventListener('click', async ()=>{
    const u = auth.currentUser; if(!u) return;
    try{
      await setDoc(doc(db,'users',u.uid), {
        username: usernameInp.value.trim(),
        notify:   notifySel.value
      }, { merge:true });
      alert('ä¿å­˜ã—ã¾ã—ãŸ');
    }catch(err){ alert(`ä¿å­˜å¤±æ•—: ${err.message}`); }
  });

  // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
  logoutBtn.addEventListener('click', async ()=>{
    await signOut(auth);
  });

  // ãƒ‹ãƒ¥ãƒ¼ã‚¹æŠ•ç¨¿
  postNewsBtn.addEventListener('click', async ()=>{
    const title = prompt('ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¿ã‚¤ãƒˆãƒ«');
    if(!title) return;
    try{
      await addDoc(collection(db,'news'), {
        title:title.trim(),
        createdAt: serverTimestamp()
      });
    }catch(err){ alert(`æŠ•ç¨¿å¤±æ•—: ${err.message}`); }
  });

  // èªè¨¼çŠ¶æ…‹ç›£è¦–
  onAuthStateChanged(auth, async (user)=>{
    if(!user){
      currentProfile = null;
      userEmailEl.textContent = 'æœªãƒ­ã‚°ã‚¤ãƒ³';
      show(authCard);
      hide(sidebar);
      hide(tabAccount); hide(tabNews); hide(tabTl);
      return;
    }

    userEmailEl.textContent = user.email;
    hide(authCard);
    show(sidebar);

    let profileSnap = await getDoc(doc(db,'users',user.uid));
    if(!profileSnap.exists()){
      await setDoc(doc(db,'users',user.uid), { Role:'User', username:'', notify:'all', createdAt: serverTimestamp() });
      profileSnap = await getDoc(doc(db,'users',user.uid));
    }
    currentProfile = profileSnap.data() || {};
    usernameInp.value = currentProfile.username ?? '';
    notifySel.value   = currentProfile.notify   ?? 'all';
    const isAdmin = currentProfile.Role === 'King';
    roleBadge.textContent = `ã‚ãªãŸã®æ¨©é™: ${currentProfile.Role ?? 'User'}` + (isAdmin ? 'ï¼ˆç®¡ç†è€…ï¼‰' : '');

    if(isAdmin) show(newsAdmin); else hide(newsAdmin);

    setActiveTab('account');

    await loadNews(isAdmin);
    await loadTimeline(isAdmin);
  });

  // ãƒ‹ãƒ¥ãƒ¼ã‚¹èª­ã¿è¾¼ã¿
  async function loadNews(isAdmin){
    newsList.innerHTML = '<li class="item"><span class="muted">èª­ã¿è¾¼ã¿ä¸­...</span></li>';
    try{
      const qRef = query(collection(db,'news'), orderBy('createdAt','desc'));
      const snap = await getDocs(qRef);
      newsList.innerHTML = '';
      if(snap.empty){
        newsList.innerHTML = '<li class="item"><span class="muted">ãƒ‹ãƒ¥ãƒ¼ã‚¹ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</span></li>';
        return;
      }
      snap.forEach(docSnap=>{
        const d = docSnap.data();
        const li = document.createElement('li');
        li.className = 'item';
        li.innerHTML = `
          <div>
            <div>${d.title ?? '(ç„¡é¡Œ)'}</div>
            <div class="time">${fmt(d.createdAt)}</div>
          </div>
        `;
        if(isAdmin){
          const del = document.createElement('button');
          del.className = 'btn danger';
          del.textContent = 'å‰Šé™¤';
          del.addEventListener('click', async()=>{
            if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){
              await deleteDoc(doc(db,'news',docSnap.id));
              li.remove();
            }
          });
          li.appendChild(del);
        }
        newsList.appendChild(li);
      });
    }catch(err){
      newsList.innerHTML = `<li class="item"><span class="muted">èª­ã¿è¾¼ã¿å¤±æ•—: ${err.message}</span></li>`;
    }
  }

  // TLèª­ã¿è¾¼ã¿
  async function loadTimeline(isAdmin){
    tlList.innerHTML = '<li class="item"><span class="muted">èª­ã¿è¾¼ã¿ä¸­...</span></li>';
    try{
      const qRef = query(collection(db,'timeline'), orderBy('createdAt','desc'));
      const snap = await getDocs(qRef);
      tlList.innerHTML = '';
      if(snap.empty){
        tlList.innerHTML = '<li class="item"><span class="muted">TLæŠ•ç¨¿ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</span></li>';
        return;
      }
      snap.forEach(docSnap=>{
        const d = docSnap.data();
        const li = document.createElement('li');
        li.className = 'item';
        li.innerHTML = `
          <div>
            <div>${d.text ?? ''}</div>
            <div class="time">${fmt(d.createdAt)} ${d.author ? `ãƒ»${d.author}`:''}</div>
          </div>
        `;
        if(isAdmin || d.author === auth.currentUser.email){
          const del = document.createElement('button');
          del.className = 'btn danger';
          del.textContent = 'å‰Šé™¤';
          del.addEventListener('click', async()=>{
            if(confirm('ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){
              await deleteDoc(doc(db,'timeline',docSnap.id));
              li.remove();
            }
          });
          li.appendChild(del);
        }
        tlList.appendChild(li);
      });
    }catch(err){
      tlList.innerHTML = `<li class="item"><span class="muted">èª­ã¿è¾¼ã¿å¤±æ•—: ${err.message}</span></li>`;
    }
  }

  // TLæŠ•ç¨¿
  tlPostBtn.addEventListener('click', async () => {
    const text = tlInput.value.trim();
    if(!text) return alert('å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    const u = auth.currentUser;
    if(!u) return alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
    try {
      await addDoc(collection(db,'timeline'), {
        text, 
        author: u.email,
        createdAt: serverTimestamp()
      });
      tlInput.value = '';
      await loadTimeline(currentProfile?.Role === 'King');
    } catch(err) {
      alert(`æŠ•ç¨¿å¤±æ•—: ${err.message}`);
    }
  });

</script>

</body>
</html>
